<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test CheWallet MercadoPago</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 400px; margin: auto; }
        label, input { display: block; margin-bottom: 10px; }
        #pay-btn { margin-top: 20px; }
        #result { margin-top: 20px; color: green; }
        #error { margin-top: 10px; color: red; }
    </style>
</head>
<body>
<div class="container">
    <h2>Test de Recarga CheWallet</h2>
    <form id="checkout-form">
        <label for="cvu">CVU:</label>
        <input type="text" id="cvu" name="cvu" required>
        <label for="amount">Monto:</label>
        <input type="number" id="amount" name="amount" required min="1" step="0.01">
        <button type="submit">Generar pago</button>
    </form>
    <div id="pay-btn"></div>
    <div id="result"></div>
    <div id="error"></div>
</div>

<script>
    const mp = new MercadoPago('APP_USR-e4ba1a0b-3402-4821-af3a-5d0b9ee12d48'); // Reemplazá con tu public key real

    document.getElementById('checkout-form').onsubmit = async function (e) {
        e.preventDefault();
        document.getElementById('pay-btn').innerHTML = '';
        document.getElementById('result').innerText = '';
        document.getElementById('error').innerText = '';

        const cvu = document.getElementById('cvu').value;
        const amount = document.getElementById('amount').value;

        try {
            // Crear preferencia en tu backend
            const res = await fetch('/api/payments/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cvu, amount })
            });

            const data = await res.json();

            const preferenceId = data.preferenceId;

            if (preferenceId) {
                // Renderiza el Brick Wallet
                mp.bricks().create("wallet", "pay-btn", {
                    initialization: {
                        preferenceId: preferenceId
                    },
                    customization: {
                        visual: { style: "default" }
                    },
                    callbacks: {
                        onError: (error) => {
                            document.getElementById('error').innerText = 'Error: ' + error.message;
                        },
                        onReady: () => {
                            document.getElementById('result').innerText = 'Brick listo para pagar.';
                        },
                        onSubmit: (data) => {
                            document.getElementById('result').innerText = 'Procesando pago...';
                        },
                        onSuccess: async (payment) => {
                            const paymentId = payment.id;
                            document.getElementById('result').innerText = 'Pago realizado. Confirmando...';

                            try {
                                // Confirmar el estado del pago en tu backend
                                const confirmRes = await fetch('/api/payments/confirm', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ paymentId })
                                });

                                const confirmData = await confirmRes.json();

                                if (confirmRes.ok) {
                                    document.getElementById('result').innerText =
                                        '✔️ ' + confirmData.message + ' (ID: ' + confirmData.paymentId + ')';
                                } else {
                                    document.getElementById('error').innerText =
                                        '❌ Error: ' + confirmData.message;
                                }
                            } catch (err) {
                                console.error(err);
                                document.getElementById('error').innerText = '❌ Error al confirmar el pago en el backend.';
                            }
                        }
                    }
                });
            } else {
                document.getElementById('error').innerText = 'No se pudo generar la preferencia.';
            }
        } catch (error) {
            console.error(error);
            document.getElementById('error').innerText = 'Error al crear la preferencia.';
        }
    };
</script>
</body>
</html>
